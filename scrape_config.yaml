# Global configuration
global:
  scrape_interval: 15s  # Default interval between scrapes

# New CR format configuration
features:
  openAgent:
    enabled: true
    # Global default settings (can be overridden in targets)
    globalInterval: "60s"
    globalPath: "/metrics"
    targets:
#     1. StaticEndpoints: Direct URL for metrics collection
      - targetName: local-minikube-api
        type: StaticEndpoints
        # Target is enabled by default (enabled: true), this can be omitted
        enabled: true
        scheme: "https"
        addresses:
          - "127.0.0.1:52684"
        path: "/metrics"
        interval: "30s"
        tlsConfig:
          insecureSkipVerify: false  # Skip certificate verification
        metricRelabelConfigs:
          # Keep only metrics with name matching "apiserver_request_total"
          - source_labels: [__name__]
            regex: "apiserver_request_total"
            action: keep
          # Add a static label "metric_src" with the value "whatap-open-agent"
          - target_label: wtp_src
            replacement: "true"
            action: replace
      # 2. ServiceMonitor: Service label selector based dynamic discovery
      - targetName: kube-apiserver
        type: ServiceMonitor
        # Target is enabled (this is the default, can be omitted)
        enabled: true
        namespaceSelector:
          matchNames:
            - "default"
        selector:
          matchLabels:
            component: apiserver
            provider: kubernetes
        endpoints:  # Endpoints to scrape from Pods connected to this Service
          - port: "https"  # Port name (or number) where metrics are exposed
            path: "/metrics"
            interval: "30s"
            tlsConfig:
              insecureSkipVerify: true  # 인증서 검증 건너뛰기
            # metricRelabelConfigs: Prometheus-style relabeling configurations for metrics
            # Used to filter metrics or modify labels after scraping
            # - source_labels: List of label names to extract values from
            # - regex: Regular expression to match against the concatenated source label values
            # - action: What to do if the regex matches (keep, drop, replace, etc.)
            # - target_label: Label to modify (for replace action)
            # - replacement: Replacement value (for replace action)
            #
            # For PodMonitor targets, you can enable the 'node' label with the addNodeLabel option
            # When enabled, the node name will be added as a 'node' label to all metrics
            # You can then use this label in relabeling configurations, for example:
            # - source_labels: [node]
            #   target_label: kubernetes_node
            #   action: replace
        metricRelabelConfigs:
          # Keep only metrics with name matching "apiserver_request_total"
          - source_labels: [__name__]
            regex: "apiserver_request_total"
            action: keep
          # Create a new label "http_verb" with the value of the "verb" label
          - source_labels: [verb]
            target_label: http_verb
            replacement: "${1}"
            action: replace
          # Add a static label "metric_src" with the value "whatap-open-agent"
          - target_label: metric_src
            replacement: "whatap-open-agent"
            action: replace
          - source_labels: [ __name__ ]
            regex: "apiserver_request_total"
            action: keep

      # 3. PodMonitor: Example for DaemonSet like dcgm-exporter with node label
      - targetName: dcgm-exporter
        type: PodMonitor
        # This target is enabled (default behavior)
        enabled: true
        namespaceSelector:
          matchNames:
            - "kube-system"
        selector:
          matchLabels:
            app: dcgm-exporter
        endpoints:
          - port: "metrics"
            path: "/metrics"
            interval: "30s"
            # You can also set addNodeLabel at the endpoint level to override the target level
            # addNodeLabel: false
        metricRelabelConfigs:
          # Use the node label in relabeling
          - source_labels: [node]
            target_label: kubernetes_node
            action: replace

      # 4. Example of a disabled target (will be skipped during scraping)
      - targetName: disabled-example
        type: StaticEndpoints
        # Set enabled to false to disable this target
        enabled: false
        addresses:
          - "example.com:9100"
        path: "/metrics"
        interval: "60s"
